name: Azure Health Check

on:
  schedule:
    # Run every 15 minutes
    - cron: "*/15 * * * *"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to check"
        required: true
        type: choice
        options:
          - all
          - dev
          - staging
          - prod

permissions:
  contents: read

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - environment: dev
            url: https://dev-app-san-tassa.azurewebsites.net
          - environment: staging
            url: https://staging-app-san-tassa.azurewebsites.net
          - environment: prod
            url: https://prod-app-san-tassa.azurewebsites.net
      fail-fast: false

    steps:
      - name: Check if environment should be tested
        id: should-test
        run: |
          INPUT_ENV="${{ github.event.inputs.environment || 'all' }}"
          MATRIX_ENV="${{ matrix.environment }}"

          if [ "$INPUT_ENV" == "all" ] || [ "$INPUT_ENV" == "$MATRIX_ENV" ]; then
            echo "test=true" >> $GITHUB_OUTPUT
          else
            echo "test=false" >> $GITHUB_OUTPUT
          fi

      - name: Health check - ${{ matrix.environment }}
        if: steps.should-test.outputs.test == 'true'
        run: |
          URL="${{ matrix.url }}"

          echo "Checking ${{ matrix.environment }} environment..."
          echo "URL: $URL"
          echo ""

          # Check homepage
          HOMEPAGE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$URL" || echo "000")
          echo "Homepage: HTTP $HOMEPAGE_STATUS"

          # Check health endpoint
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$URL/api/health" || echo "000")
          echo "Health endpoint: HTTP $HEALTH_STATUS"

          # Check API products endpoint
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$URL/api/products" || echo "000")
          echo "Products API: HTTP $API_STATUS"

          # Determine overall health
          if [ "$HOMEPAGE_STATUS" -ge 200 ] && [ "$HOMEPAGE_STATUS" -lt 400 ] && \
             [ "$HEALTH_STATUS" -ge 200 ] && [ "$HEALTH_STATUS" -lt 400 ]; then
            echo ""
            echo "✓ ${{ matrix.environment }} environment is healthy"
            exit 0
          else
            echo ""
            echo "✗ ${{ matrix.environment }} environment has issues"
            exit 1
          fi

      - name: Report status
        if: steps.should-test.outputs.test == 'true' && always()
        run: |
          echo "## Health Check: ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ matrix.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ matrix.url }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "| Status | ✅ Healthy |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Status | ❌ Unhealthy |" >> $GITHUB_STEP_SUMMARY
          fi

  alert-on-failure:
    name: Alert on Failure
    runs-on: ubuntu-latest
    needs: health-check
    if: failure()

    steps:
      - name: Create failure alert
        run: |
          echo "## ⚠️ Health Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more environments failed their health checks." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action required:** Investigate the failing environment(s)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Check Application Insights for errors" >> $GITHUB_STEP_SUMMARY
          echo "2. Review recent deployments" >> $GITHUB_STEP_SUMMARY
          echo "3. Check Azure App Service status in the Azure Portal" >> $GITHUB_STEP_SUMMARY
          echo "4. Review database connectivity" >> $GITHUB_STEP_SUMMARY
